name: Desplegar Firebase Functions

on:
  push:
    branches:
      - main
    paths:
      - 'functions/**'
      - '.github/workflows/deploy.yml' # ¡Trigger nuevo!

jobs:
  deploy_functions:
    runs-on: ubuntu-latest # 1. Servidor Limpio

    steps:
      # 2. Trae tu código
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 3. Configura Node 22
      - name: Configurar Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'yarn'
          # --- ¡AQUÍ ESTÁ LA CORRECCIÓN! ---
          # Le decimos que se base en el package.json, no en el yarn.lock
          cache-dependency-path: 'functions/package.json'

      # 4. Instala el "camión" (firebase-tools)
      - name: Instalar Firebase Tools
        run: sudo npm install -g firebase-tools

      # 5. Instala los "ingredientes" (con yarn)
      - name: Instalar dependencias de functions
        working-directory: ./functions
        run: yarn install # ¡Sin "frozen-lockfile" para que genere uno nuevo!

      # 6. Crear el archivo .env para el despliegue
      - name: Crear archivo .env
        working-directory: ./functions
        run: echo "DAILY_APIKEY=${{ secrets.DAILY_APIKEY }}" > .env.mi-app-coaching-1df37

      # 7. ¡El Despliegue Final!
      - name: Desplegar en Firebase
        run: |
          firebase deploy --only functions --token "${{ secrets.FIREBASE_SERVICE_ACCOUNT_MI_APP_COACHING_1DF37 }}"
